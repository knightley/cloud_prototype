language: c

before_script:
  - sudo apt update
  - sudo apt install -y cmake tree
  - pyenv global 3.7.1
  - pip3 install requests boto3
  - export PATH=$PATH:$HOME/build/knightley/cloud_prototype/bin
  - echo $PATH
# install xcal agent
  - wget -q https://ci-integration.oss-cn-shanghai.aliyuncs.com/xcal-agent.tgz && tar -xf xcal-agent.tgz -C $HOME/build && cd $HOME/build/xcal-agent/xcalbuild/linux/bear && sudo rm -rf build && mkdir build && cd build && cmake .. && make && sudo make install
  - which bear
  - export PYTHONPATH=$HOME/build/xcal-agent/agent:$HOME/build/xcal-agent/agent/commondef/src
  - echo $PYTHONPATH
# install submit task
  - wget -q https://ci-integration.oss-cn-shanghai.aliyuncs.com/submit_task.tgz && tar -zxvf submit_task.tgz -C /home/travis/build/knightley/cloud_prototype && cd /home/travis/build/knightley/cloud_prototype/install && . ./install_submit_task.sh && . ./set_path.sh
  - cd /home/travis/build/knightley/cloud_prototype/c_testcase/basic

env:
  - USER_ID='knightley'
  
stage: compile
script:
  - make
  - $HOME/build/xcal-agent/tools/xcal-agent.py -pc $HOME/build/knightley/cloud_prototype/xcal-preprocess.conf -a -d

after_success:
  - tree .xcalagent
  - cd "$(dirname "$(find . -type f -name xcal-task.conf | head -1)")" && before_submit.sh && ls && cat xcal-task.conf && submit_task.sh xcal-task.conf
